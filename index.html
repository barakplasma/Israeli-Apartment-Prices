<!DOCTYPE html>
<html>
<head>
    <title>Rental Price Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"></script>
    
    <script src='https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js'></script>

    <script src="./rentalData.js"></script>

    <style>
        #map { width: 800px; height: 600px; }
        body { font: 16px/1.4 "Helvetica Neue", Arial, sans-serif; }
        .ghbtns { position: relative; top: 4px; margin-left: 5px; }
        a { color: #0077ff; }
    </style>
</head>
<body>

<p>
    1 Room Rental Prices in Tel Aviv
</p>

<div id="map"></div>

<script>
var map = L.map('map').setView([32.097244,34.774262], 13);

var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);

housingPrices = housingPrices.filter(p=>Number.isFinite(p[2]));

// generate statistics
var jstat = window.jStat(housingPrices.map(p=>p[2])); // jStat will be added to the window
const priceDistribution = jstat.quantiles([0.25, 0.5, 0.75]);

const priceDistributionDisplay = document.createTextNode(`price quantiles = .25: ${priceDistribution[0]}, .5: ${priceDistribution[1]}, .75: ${priceDistribution[2]}`);
document.body.appendChild(priceDistributionDisplay);

document.body.appendChild(document.createElement('br'));

const averagePriceElement = document.createTextNode(`average price is ${Math.floor(jstat.mean())}`);
document.body.appendChild(averagePriceElement);

document.body.appendChild(document.createElement('br'));

const priceHistogramDisplay = document.createTextNode(`price histogram: ${jstat.histogram(4)}`);
document.body.appendChild(priceHistogramDisplay);

// add markers
const circle = (fill) => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <circle cx="100" cy="100" r="100" fill="hsl(${(1 - fill) * 80}, 100%, 50%)" opacity="0.5"/>
  </svg>`;

housingPrices.forEach(price => {
    const actualPrice = price[2];
    let markerLocation = new L.LatLng(price[0], price[1]);
    let icon = L.icon({iconUrl: `data:image/svg+xml;charset=utf-8,${encodeURIComponent(circle(jstat.percentileOfScore(actualPrice)))}`, iconSize: [50, 50]})
    let marker = new L.Marker(markerLocation, {icon});
    map.addLayer(marker);
            
    marker.bindPopup(`price: ${actualPrice}, <a href="${price[3]}" target="_blank">view listing</a>`);
});

</script>
</body>
</html>
